name: deploy

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.meta.outputs.tags }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Build WAR with Gradle
      run: |
        chmod +x gradlew
        ./gradlew war

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=tag

    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max


  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    - name: Copy files to server
      run: |
        scp docker-compose.prod.yml ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/app/docker-compose.yml
        scp nginx/conf.d/nginx.conf ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/app/nginx/conf.d/nginx.conf

    - name: Deploy application
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          set -e
          cd /app
          
          export GITHUB_USERNAME=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          export REPO_NAME=$(echo '${{ github.event.repository.name }}' | tr '[:upper:]' '[:lower:]')
          export TAG='${{ github.ref_name }}'
          export REGISTRY='${{ env.REGISTRY }}'
          
          echo '=== Starting deployment process ==='
          echo \"Deploying image: \$REGISTRY/\$GITHUB_USERNAME/\$REPO_NAME:\$TAG\"
          
          echo '${{ secrets.GHCR_TOKEN }}' | docker login \$REGISTRY -u '${{ github.repository_owner }}' --password-stdin
          echo '‚úÖ Logged into GHCR'
          
          echo 'Pulling new Docker image...'
          docker compose -f docker-compose.yml pull
          echo '‚úÖ Image pulled successfully'
          
          echo 'Starting services with docker-compose...'
          docker compose -f docker-compose.yml up -d
          echo '‚úÖ Services started successfully'
          
          echo 'Checking service health...'
          sleep 20  # –î–∞–µ–º –≤—Ä–µ–º—è —Å–µ—Ä–≤–∏—Å–∞–º –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
          docker compose -f docker-compose.yml ps
          
          echo 'Cleaning up old images...'
          docker image prune -f
          echo '‚úÖ Cleanup completed'
          
          echo 'üéâ Deployment completed successfully!'
        "
